rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /* ================= HELPERS ================= */

    function isLoggedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isLoggedIn()
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid))
            .data.role == 'admin';
    }

    function isPartner() {
      return isLoggedIn()
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && get(/databases/$(database)/documents/users/$(request.auth.uid))
            .data.role == 'partner';
    }

    /* ================= USERS ================= */

    match /users/{uid} {
      allow read, write: if isLoggedIn() && uid == request.auth.uid;
    }

    /* ================= PARTNERS ================= */

    match /partners/{pid} {

      // First time create (onboarding)
      allow create: if isLoggedIn() && pid == request.auth.uid;

      // Partner reads / updates own profile
      allow read, update: if isPartner() && pid == request.auth.uid;

      // Admin full access
      allow read, write: if isAdmin();
    }

    /* ================= FARMERS (FINAL SIMPLE & STABLE) ================= */

    match /farmers/{farmerId} {

      // ✅ CREATE FARMER
      allow create: if isPartner()
        && request.resource.data.partnerId == request.auth.uid;

      // ✅ READ (list + single doc)
      allow read: if isPartner()
        && resource.data.partnerId == request.auth.uid;

      // ✅ UPDATE
      allow update: if isPartner()
        && resource.data.partnerId == request.auth.uid;

      // ❌ DELETE
      allow delete: if false;

      // ✅ ADMIN
      allow read, write: if isAdmin();
    }

    /* ================= FARMER SUBSCRIPTIONS (FINAL – QUERY SAFE) ================= */

    match /farmers/{farmerId}/subscriptions/{subId} {

      // ✅ QUERY + DOC READ (SAFE)
      allow read: if isPartner();

      // ✅ CREATE
      allow create: if isPartner()
        && request.resource.data.partnerId == request.auth.uid;

      // ❌ UPDATE / DELETE
      allow update, delete: if false;

      // ✅ ADMIN
      allow read, write: if isAdmin();
    }

    /* ================= WALLET LEDGER ================= */

    match /wallet_ledger/{docId} {
      allow read, write: if isAdmin();
    }

    /* ================= WITHDRAW REQUESTS ================= */

    match /withdraw_requests/{docId} {

      // Partner creates own withdraw request
      allow create: if isPartner()
        && request.resource.data.partnerId == request.auth.uid;

      // Partner reads only his requests
      allow read: if isPartner()
        && resource.data.partnerId == request.auth.uid;

      // Partner cannot update/delete
      allow update, delete: if false;

      // Admin full access
      allow read, write: if isAdmin();
    }
  }
}
